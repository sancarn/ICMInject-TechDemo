<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv='X-UA-Compatible' content='IE=edge'>
		<meta charset='utf-8'>
		<!--base href='%mainDirURI%'-->
		<link rel="stylesheet" type="text/css" href="main.css">
		<title>ICM Tools</title>
		<script>
			// r.SL_Select(1)
			// r.SL_Select({a:1,b:{a:1,b:2,c:[1,2,3]}})
			
			window.addEventListener("load",function(){
				window.r = {}
				Object.keys(window.rb).forEach(function(key){
					window.r[key] = registerScript(window.rb[key])
				})
			})
			
			function registerScript(func){
				var data = /function\s*(.*?)\s*\((.*?)\){\s*?\/\*((.|\s)*?)\*\/\s*?}/.exec(func.toString())
				var aArgs = data[2].split(",")
				var rbBody = data[3]
				
				sArgs=JSON.stringify("require('json');\n") + "+\n"
				aArgs.forEach(function(argument){
					sArgs = sArgs + JSON.stringify(argument) + "+" + JSON.stringify("= JSON.parse(") + "+" + "prepareArgument(" + argument + ")" + "+" + JSON.stringify(");\n")
				})
				
				var jsBody = "var data = " + sArgs + "+" + JSON.stringify(rbBody) + "; console.log(data)"
				var aCons = aArgs
				aCons.push(jsBody)
				return (Function.constructor.apply(this,aCons))
			}
			function prepareArgument(arg){
				try {
					return JSON.stringify(JSON.stringify(arg))
				} catch(e) {
					console.log(arg)
					throw new Error("Error in prepareArgument")
				}
			}
		</script>
		
		
		<script>
			window.rb = window.rb ? window.rb : {}
			window.rb["SL_Recent"] = function(){/*
			    require_relative('libs\WSLocalStorage.rb')
				localStorage = WSLocalStorage.new("a8344089-9f06-4058-9955-57283c090659")
				selectionLists = WSApplication.current_database.model_object_collection('Selection list')
				localStorage[:id] = selectionLists[-1].id
			*/}
			
			window.rb["SL_Append"] = function(){/*
				require_relative('libs\WSLocalStorage.rb')
				localStorage = WSLocalStorage.new("a8344089-9f06-4058-9955-57283c090659")
				if localStorage[:id]
				  net = WSApplication.current_network
				  net.load_selection localStorage[:id]
				  net.save_selection localStorage[:id]
				end
			*/}
			
			window.rb["SL_Subtract"] = function(){/*
				require_relative('libs\WSLocalStorage.rb')
				localStorage = WSLocalStorage.new("a8344089-9f06-4058-9955-57283c090659")
				if localStorage[:id]
				  net = WSApplication.current_network
				  to_remove = {}
				  net.table_names.each do |table|
					to_remove[table] = []
					net.row_object_collection_selection(table).each do |ro|
					  to_remove[table].push(ro.id)
					end
				  end
				  
				  net.clear_selection
				  net.load_selection localStorage[:id]
				  
				  net.table_names.each do |table|
					try_remove = to_remove[table]
					net.row_object_collection_selection(table).each do |ro|
					  if try_remove.index ro.id
						ro.selected = false
					  end
					end
				  end
				  
				  net.save_selection localStorage[:id]
				end
			*/}
			
			window.rb["SL_Clear"] = function(){/*
				require_relative('libs\WSLocalStorage.rb')
				localStorage = WSLocalStorage.new("a8344089-9f06-4058-9955-57283c090659")
				if localStorage[:id]
				  net = WSApplication.current_network
				  net.clear_selection
				  net.save_selection localStorage[:id]
				end
			*/}
			
			window.rb["SL_Overwrite"] = function(){/*
				require_relative('libs\WSLocalStorage.rb')
				localStorage = WSLocalStorage.new("a8344089-9f06-4058-9955-57283c090659")
				if localStorage[:id]
				  WSApplication.current_network.save_selection localStorage[:id]
				end
			*/}
			
			window.rb["SL_Select"] = function(id){/*
				require_relative('libs\WSLocalStorage.rb')
				localStorage = WSLocalStorage.new("a8344089-9f06-4058-9955-57283c090659")
				localStorage[:id] = id
			*/}
			
			window.rb["SL_Temporary"] = function(){/*
				require_relative('libs\WSLocalStorage.rb')
				require_relative('libs\WSVirtualSL.rb')
				
				localStorage = WSLocalStorage.new("a8344089-9f06-4058-9955-57283c090659")
				sl = WSVirtualSL.new
				
				if localStorage[:tmp_list]
				  localStorage[:tmp_list].push(sl)
				  localStorage[:isTemporary] = true
				  return localStorage[:tmp_list].length
				end
			*/}
		</script>
	</head>
	<body>
		<div id="Geoplan" class="tabcontent">
			<button class="ribButton" onclick='handle("USTrace")'>
				<div class="image" style="background-image:url('img\\SelectionTool_UpstreamTrace.png');"></div>
				<div class="describer">
					<span>US Trace</span>
				</div>
			</button>
			<button class="ribButton" onclick='handle("DSTrace")'>
				<div class="image" style="background-image:url('img\\SelectionTool_DownstreamTrace.png');"></div>
				<div class="describer">
					<span>DS Trace</span>
				</div>
			</button>
		</div>
	</body>
</html>